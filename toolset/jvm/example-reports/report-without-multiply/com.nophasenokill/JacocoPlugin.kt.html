<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JacocoPlugin.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacocoTest.exec</a> &gt; <a href="index.source.html" class="el_package">com.nophasenokill</a> &gt; <span class="el_source">JacocoPlugin.kt</span></div><h1>JacocoPlugin.kt</h1><pre class="source lang-java linenums">package com.nophasenokill

import com.nophasenokill.extensions.configurePlugin
import com.nophasenokill.extensions.registerAndConfigureTask
import org.gradle.api.Plugin
import org.gradle.api.Project
import org.gradle.api.plugins.ApplicationPlugin
import org.gradle.api.plugins.JavaPluginExtension
import org.gradle.api.tasks.JavaExec
import org.gradle.api.tasks.TaskProvider
import org.gradle.api.tasks.testing.Test
import org.gradle.testing.jacoco.plugins.JacocoPluginExtension
import org.gradle.testing.jacoco.plugins.JacocoTaskExtension
import org.gradle.testing.jacoco.tasks.JacocoReport
import org.jetbrains.kotlin.gradle.utils.named


<span class="nc" id="L18">class JacocoPlugin: Plugin&lt;Project&gt; {</span>
    override fun apply(project: Project) {
<span class="nc" id="L20">        project.run {</span>
<span class="nc" id="L21">            applyJacocoPlugin()</span>

<span class="nc" id="L23">            val testTask = project.tasks.named&lt;Test&gt;(&quot;test&quot;)</span>

<span class="nc" id="L25">            pluginManager.withPlugin(&quot;application&quot;) {</span>

<span class="nc" id="L27">                val runTask = tasks.named&lt;JavaExec&gt;(ApplicationPlugin.TASK_RUN_NAME)</span>

<span class="nc" id="L29">                configureJacocoExtension(runTask)</span>
<span class="nc" id="L30">                addApplicationReportTask(runTask)</span>
<span class="nc" id="L31">            }</span>

<span class="nc" id="L33">            configureTestTask(testTask)</span>
<span class="nc" id="L34">            ensureTestsRunBeforeGeneratingReport(testTask)</span>

<span class="nc" id="L36">            val jacocoTestReport = tasks.named&lt;JacocoReport&gt;(&quot;jacocoTestReport&quot;)</span>

<span class="nc" id="L38">            configureJacocoTestReportTask(jacocoTestReport)</span>
<span class="nc" id="L39">            registerSessionsTask(jacocoTestReport)</span>
<span class="nc" id="L40">            registerComparisonTask()</span>
<span class="nc" id="L41">        }</span>
<span class="nc" id="L42">    }</span>


    private fun Project.applyJacocoPlugin() {
<span class="nc" id="L46">        pluginManager.apply(&quot;org.gradle.jacoco&quot;)</span>
<span class="nc" id="L47">    }</span>

    private fun Project.configureJacocoExtension(runTask: TaskProvider&lt;out JavaExec&gt;) {
<span class="nc" id="L50">        configurePlugin&lt;JacocoPluginExtension&gt; {</span>
<span class="nc" id="L51">            applyTo(runTask.get())</span>
<span class="nc" id="L52">        }</span>
<span class="nc" id="L53">    }</span>


    private fun Project.addApplicationReportTask(runTask: TaskProvider&lt;out JavaExec&gt;) {

<span class="nc" id="L58">        registerAndConfigureTask&lt;JacocoReport&gt;(&quot;applicationCodeCoverageReport&quot;) {</span>
<span class="nc" id="L59">            val javaSourceSet = project.extensions.getByType(JavaPluginExtension::class.java).sourceSets.getByName(&quot;main&quot;)</span>

<span class="nc" id="L61">            executionData(runTask)</span>
<span class="nc" id="L62">            sourceSets(javaSourceSet)</span>
<span class="nc" id="L63">        }</span>
<span class="nc" id="L64">    }</span>


    private fun Project.configureTestTask(testTask: TaskProvider&lt;Test&gt;) {
<span class="nc" id="L68">        testTask.get().extensions.configure(JacocoTaskExtension::class.java) { extension: JacocoTaskExtension -&gt;</span>
<span class="nc" id="L69">            extension.destinationFile = layout.buildDirectory.file(&quot;jacoco/jacocoTest.exec&quot;).get().asFile</span>
            /*
                Please note that this only gets put into the build dir the first time the task is run locally.
                It appears to then delete this/use other caching mechanisms, meaning that the next run,
                which deletes the destination file, will remove this dir.

                To ensure this is being generated, you will need to fully remove caches and try running
                buildAll again
             */
<span class="nc" id="L78">            extension.classDumpDir = layout.buildDirectory.dir(&quot;jacoco/classpathdumps&quot;).get().asFile</span>
<span class="nc" id="L79">        }</span>
<span class="nc" id="L80">    }</span>

    private fun Project.ensureTestsRunBeforeGeneratingReport(testTask: TaskProvider&lt;Test&gt;) {
<span class="nc" id="L83">        tasks.withType(JacocoReport::class.java).configureEach { jacocoReportTask -&gt;</span>
<span class="nc" id="L84">            jacocoReportTask.dependsOn(testTask)</span>
<span class="nc" id="L85">        }</span>
<span class="nc" id="L86">    }</span>

    private fun Project.configureJacocoTestReportTask(jacocoTestReport: TaskProvider&lt;JacocoReport&gt;) {

<span class="nc" id="L90">        jacocoTestReport.get().reports.html.outputLocation.set(layout.buildDirectory.dir(&quot;jacocoHtmlOutputs&quot;))</span>
<span class="nc" id="L91">        jacocoTestReport.get().reports.xml.required.set(false)</span>
<span class="nc" id="L92">        jacocoTestReport.get().reports.csv.required.set(false)</span>
<span class="nc" id="L93">    }</span>

    private fun Project.registerComparisonTask() {
<span class="nc" id="L96">        tasks.register(&quot;compareSessions&quot;) {</span>
<span class="nc" id="L97">            it.dependsOn(tasks.named(&quot;sessions&quot;))</span>

<span class="nc" id="L99">            val currentSessionFile = layout.buildDirectory.file(&quot;jacoco-session/jacoco-sessions.txt&quot;)</span>
<span class="nc" id="L100">            val previousSessionFile = layout.buildDirectory.file(&quot;jacoco-session/previous-jacoco-sessions.txt&quot;)</span>
<span class="nc" id="L101">            val shouldRunTests = layout.buildDirectory.file(&quot;jacoco-session/should-run-tests.txt&quot;)</span>
<span class="nc" id="L102">            val difference = layout.buildDirectory.file(&quot;jacoco-session/difference.txt&quot;)</span>

<span class="nc" id="L104">            it.inputs.file(tasks.named(&quot;sessions&quot;).get().outputs.files.first())</span>
<span class="nc" id="L105">            it.outputs.files(previousSessionFile, shouldRunTests, difference)</span>

<span class="nc" id="L107">            it.doLast {</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                val currentContentLines = if (currentSessionFile.get().asFile.exists()) {</span>
<span class="nc" id="L109">                    currentSessionFile.get().asFile.readLines()</span>
                } else {
<span class="nc" id="L111">                    logger.warn(&quot;Current session file not found.&quot;)</span>
<span class="nc" id="L112">                    shouldRunTests.get().asFile.createNewFile()</span>
<span class="nc" id="L113">                    shouldRunTests.get().asFile.writeText(&quot;true&quot;)</span>
<span class="nc" id="L114">                    return@doLast</span>
                }

<span class="nc bnc" id="L117" title="All 2 branches missed.">                val previousContentLines = if (previousSessionFile.get().asFile.exists()) {</span>
<span class="nc" id="L118">                    previousSessionFile.get().asFile.readLines()</span>
                } else {
                    // No previous data to compare with, assume first run
<span class="nc" id="L121">                    logger.info(&quot;No previous session file found. Saving current as previous for future comparisons.&quot;)</span>
<span class="nc" id="L122">                    previousSessionFile.get().asFile.writeText(currentContentLines.joinToString(&quot;\n&quot;))</span>
<span class="nc" id="L123">                    shouldRunTests.get().asFile.createNewFile()</span>
<span class="nc" id="L124">                    shouldRunTests.get().asFile.writeText(&quot;true&quot;)</span>
<span class="nc" id="L125">                    return@doLast</span>
                }

                // Detect and print line differences
<span class="nc" id="L129">                val differences = currentContentLines.zip(previousContentLines).filterNot { (current, previous) -&gt; current == previous }</span>
<span class="nc bnc" id="L130" title="All 4 branches missed.">                if (differences.isEmpty() &amp;&amp; currentContentLines.size == previousContentLines.size) {</span>
<span class="nc" id="L131">                    logger.lifecycle(&quot;No changes detected between sessions.&quot;)</span>
<span class="nc" id="L132">                    shouldRunTests.get().asFile.createNewFile()</span>
<span class="nc" id="L133">                    shouldRunTests.get().asFile.writeText(&quot;false&quot;)</span>
                } else {
<span class="nc" id="L135">                    logger.lifecycle(&quot;Changes detected between sessions!&quot;)</span>
<span class="nc" id="L136">                    difference.map { it.asFile.createNewFile() }</span>
<span class="nc" id="L137">                    differences.forEach { (current, previous) -&gt;</span>
<span class="nc" id="L138">                        difference.get().asFile.appendText(&quot;Previous: $previous -&gt; Current: $current&quot;)</span>
<span class="nc" id="L139">                        logger.lifecycle(&quot;Previous: $previous -&gt; Current: $current&quot;)</span>
<span class="nc" id="L140">                    }</span>

                    // Check for extra lines in current file
<span class="nc bnc" id="L143" title="All 2 branches missed.">                    if (currentContentLines.size &gt; previousContentLines.size) {</span>
<span class="nc" id="L144">                        currentContentLines.subList(previousContentLines.size, currentContentLines.size).forEach {</span>
<span class="nc" id="L145">                            difference.get().asFile.appendText(&quot;Previous: null -&gt; Current: $it&quot;)</span>
<span class="nc" id="L146">                            logger.lifecycle(&quot;New line: $it&quot;)</span>
<span class="nc" id="L147">                        }</span>
                    }

<span class="nc" id="L150">                    shouldRunTests.get().asFile.createNewFile()</span>
<span class="nc" id="L151">                    shouldRunTests.get().asFile.writeText(&quot;true&quot;)</span>
                }

                // Update the previous file with current for next comparison
<span class="nc" id="L155">                previousSessionFile.get().asFile.writeText(currentContentLines.joinToString(&quot;\n&quot;))</span>
<span class="nc" id="L156">            }</span>
<span class="nc" id="L157">        }</span>
<span class="nc" id="L158">    }</span>

    private fun Project.registerSessionsTask(jacocoTestReport: TaskProvider&lt;JacocoReport&gt;) {
<span class="nc" id="L161">        tasks.register(&quot;sessions&quot;) {</span>
<span class="nc" id="L162">            it.mustRunAfter(jacocoTestReport)</span>
<span class="nc" id="L163">            it.dependsOn(jacocoTestReport)</span>

<span class="nc" id="L165">            val inputDir = jacocoTestReport.get().outputs.files.asFileTree</span>
<span class="nc" id="L166">            val outputDir = layout.buildDirectory.dir(&quot;jacoco-session&quot;)</span>
<span class="nc" id="L167">            val newFile = outputDir.map { it.asFile.resolve(&quot;jacoco-sessions.txt&quot;) }</span>

<span class="nc" id="L169">            it.inputs.files(inputDir)</span>
<span class="nc" id="L170">            it.outputs.file(newFile)</span>

<span class="nc" id="L172">            it.doLast {</span>
<span class="nc" id="L173">                outputDir.get().asFile.mkdirs()</span>

<span class="nc" id="L175">                val sessionFile = inputDir.files.firstOrNull { it.name == &quot;jacoco-sessions.html&quot; }</span>
<span class="nc bnc" id="L176" title="All 4 branches missed.">                if (sessionFile != null &amp;&amp; sessionFile.exists()) {</span>

<span class="nc" id="L178">                    newFile.get().createNewFile()</span>
<span class="nc" id="L179">                    val readContents = extractClassData(sessionFile.readText())</span>
<span class="nc" id="L180">                    val allContents = readContents.map { it.toString() }</span>
<span class="nc" id="L181">                    val allContent = allContents.joinToString(separator = &quot;\n&quot;) { content -&gt; content }</span>
<span class="nc" id="L182">                    newFile.get().writeText(allContent) // Writes all content at once, overwriting any existing content</span>

                } else {
<span class="nc" id="L185">                    logger.info(&quot;Jacoco sessions file not found, skipping 'sessions' task.&quot;)</span>
                }
<span class="nc" id="L187">            }</span>
<span class="nc" id="L188">        }</span>
<span class="nc" id="L189">    }</span>

    private fun extractClassData(html: String): Map&lt;String, String&gt; {
<span class="nc" id="L192">        val result = mutableMapOf&lt;String, String&gt;()</span>
<span class="nc" id="L193">        val rows = html.split(&quot;&lt;tr&gt;&quot;).drop(1)</span>

<span class="nc bnc" id="L195" title="All 2 branches missed.">        for (row in rows) {</span>

<span class="nc" id="L197">            val classStart = row.indexOf(&quot;&gt;&quot;) + 1</span>
<span class="nc" id="L198">            val classEnd = row.indexOf(&quot;&lt;/&quot;)</span>
<span class="nc bnc" id="L199" title="All 4 branches missed.">            if (classStart == 0 || classEnd == -1) continue</span>
<span class="nc" id="L200">            val classNamePart = row.substring(classStart, classEnd)</span>
<span class="nc" id="L201">            val className = classNamePart.split(&quot;&gt;&quot;).last().split(&quot;&lt;&quot;).first()</span>


<span class="nc" id="L204">            val idStart = row.indexOf(&quot;&lt;code&gt;&quot;) + 6</span>
<span class="nc" id="L205">            val idEnd = row.indexOf(&quot;&lt;/code&gt;&quot;)</span>
<span class="nc bnc" id="L206" title="All 4 branches missed.">            if (idStart &lt; 6 || idEnd == -1) continue</span>
<span class="nc" id="L207">            val classId = row.substring(idStart, idEnd)</span>

<span class="nc bnc" id="L209" title="All 8 branches missed.">            if (className.isNotEmpty() &amp;&amp; classId.isNotEmpty()) {</span>
<span class="nc" id="L210">                result[className] = classId</span>
            }
        }
<span class="nc" id="L213">        return result</span>
    }
}







</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>